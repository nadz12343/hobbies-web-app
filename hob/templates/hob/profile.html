{% extends "hob/base.html" %}

{% block content %}

<div id="profile">

    

    {% csrf_token %}
    
    <div class="container mt-5">
        <h1 class="display-2">Profile page</h1>
        <div class="row justify-content-md-center mt-5">
            <div class="col col-lg-5" v-for="u in user">
                <h1 class="display-4">[[u.firstname]] [[u.lastname]]</h1>
                
                <ul class="list-group" style="font-size: 20px">
                    <li class="list-group-item">
                        <span v-if="!editing">@[[u.username]]</span>
                        <input type="text" class="form-control" v-else v-model="u.username">
                    </li>
                    <li class="list-group-item">
                        <span v-if="!editing">[[u.firstname]]</span>
                        <input type="text" class="form-control" v-else v-model="u.firstname">
                    </li>
                    <li class="list-group-item">
                        <span v-if="!editing">[[u.lastname]]</span>
                        <input type="text" class="form-control" v-else v-model="u.lastname">
                    </li>
                </ul>
                <div class="mt-3">
                    <button type="button" class="btn btn-primary" v-if="!editing " @click="editing = true" title="edit">Edit profile <i class="far fa-edit"></i></button>
                    <button type="button" class="btn btn-secondary" v-else @click="updateUserAccount(u)">Save changes <i class="far fa-save"></i></button>
                    &nbsp;
                    <button type="button" class="btn btn-info" v-if="editing" @click="editing = false" title="cancel">Cancel changes <i class="far fa-times-circle"></i></button>
                </div>

                <hr id="profile-hr">

                <h1 class="display-4">Friend requests</h1>

                <div class="list-group">
                    <div class="list-group-item list-group-item-action flex-column align-items-start">
                      <div class="d-flex w-100 justify-content-between mb-3">
                        <h5 class="mb-1">List group item heading</h5>
                        <small>3 days ago</small>
                      </div>
                      <button type="button" class="btn btn-success" @click="manageRequest('accept', req.from)">Accept invite</button>
                        <button type="button" class="btn btn-danger" @click="manageRequest('decline', req.from)">Decline invite</button>
                    </div>
                </div>

                <div v-for="req in friend_requests">
                    <div class="card mb-3 mr-3" style="height: 100px;">
                        <div class="card-body" style="float: left;">
                          <h5 class="card-title">[[req.from.firstname]] [[req.from.lastname]]</h5>
                          <button type="button" class="btn btn-success" @click="manageRequest('accept', req.from)">Accept invite</button>
                          <button type="button" class="btn btn-danger" @click="manageRequest('decline', req.from)">Decline invite</button>
                        </div>
                    </div>
                </div>

            </div>
            <div class="col col-lg-77">
                <h1 class="display-4">My Hobbies</h1>
                <table>
                    <thead>
                        <tr>
                            <th scope="col" width = 400>Hobby</th>
                            <th scope="col" width = 2000>Description</th>
                            <th scope="col" width = 400>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="h in hobbies">
                            <td>
                                [[h.name]]
                            </td>
                            <td>
                                [[h.description]]
                            </td>
                            <td>
                                <button class="btn btn-dark btn-sm" @click="removeHobbyFromList(h)">Remove</button>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <hr id="profile-hr">
                <h1 class="display-4">My Friends</h1>
                <div v-for="u in user">
                    <div v-for="f in u.friends">
                        <h3 >[[f.firstname]] [[f.lastname]]</h3>
                        <p>[[f.username]]</p>
                        <hr id="friend-sep">
                    </div>
                    
                </div>
            </div>
        </div>
    </div>
</div>    

{% endblock content %}

{% block scripts %}
<script>

    // https://vuejs.org/v2/api/
    // https://docs.djangoproject.com/en/3.2/ref/models/querysets/#django.db.models.query.QuerySet.create
    // https://realpython.com/python-pep8/

    const app = Vue.createApp({
        delimiters: ['[[', ']]'],
        data() {
            return {
                user: [],
                friend_requests: [],
                editing: false,
                hobbies: [],
            }
        },
        async mounted() {
            try {
                const res = await fetch("{% url 'get-user-details' %}")
                const data = await res.json()
                this.user = data.user
                this.hobbies = data.user[0].hobbies
                console.log(data)
                this.friend_requests = data.requests
            }
            catch(error) {
                alert("ERROR: API fetch failed")
            }
        },
        methods: {
            async updateUserAccount(u) {
                try {
                    const res = await fetch("{% url 'update-user-details' %}", { 
                        method: 'PUT', 
                        headers: {
                            "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value
                        },
                        body: JSON.stringify({
                            'firstname': u.firstname,
                            'lastname': u.lastname,
                            'username': u.username,
                        })
                    })
                }
                catch(error) {
                    alert("ERROR: record was not deleted!")
                }
                this.editing=false
            },
            async manageRequest(action, req ) {
                console.log(req.api)
                try {
                    const res = await fetch(req.api, { 
                        method: 'DELETE', 
                        headers: {
                            "Content-Type": "application/json",
                            "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value,
                        },
                        body: JSON.stringify({
                            'action': action,
                        })
                    })
                }
                catch(error) {
                    alert("ERROR: record was not deleted!")
                }
                const res1 = await fetch("{% url 'get-user-details' %}")
                const data = await res1.json()
                this.user = data.user
                this.friend_requests = data.requests
            },
            async removeHobbyFromList(h) {
            console.log("ive entered")
            try {
                const res = await fetch(h.api, { 
                    method: 'DELETE', 
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value,
                    },
                })
                const res1 = await fetch("{% url 'get-user-details' %}")
                const data = await res1.json()
                this.user = data.user
            }
            catch(error) {
                alert("ERROR: record was not deleted!")
            }
        }
        }
    })
    app.mount('#profile')
</script>
{% endblock %}